<meta name='viewport' content='width=device-width, initial-scale=1'/><script>onload=()=>{ ide();function ide(){
document.title="Bacione Javascript Editor";
let tested="Tested on: Android 13, Chrome 121, tablet and phone"; if(navigator.maxTouchPoints<2){alert(tested);return;}
let user="bacionejs";
let file="bacione.html";
let url=`https://raw.githubusercontent.com/${user}/editor/main/${file}`;
let about=`${document.title} is an Integrated Development Environment (IDE) for programming small javascript games on a phone. Several games are included.
License: GPL
Github: github.com/${user}
${tested}`;
let download=`The editor is one file including the games.
Download <a href=${url}>${file}</a>, open your file manager, click ${file} to run in your Chrome browser, click Run to play the Ski game.
You may have to close and reopen ${file} the first time.`;

element("style").textContent=`
*{margin:0;padding:0;box-sizing:border-box;scrollbar-width:none;}
body{background-color:red;}
::selection{background:yellow;color:red;}
.view{
  width:100%;
  height:100%;
  background-color:white;
  font-family:monospace;
  padding:2ch;
  touch-action:pan-x pan-y;
  position:fixed;
  white-space:pre-wrap;
  overflow-y:scroll;
}
@media print{
  div,p{break-inside:avoid;}
  body{visibility:hidden;height:99%;}
  .unhide{
    visibility:visible;
    white-space:pre-wrap !important;
    position:static !important;
    overflow:visible !important;
  }
}
`;//end style

let colortextareaforeground="lime";
let colortextareabackground="black";
let colorkeyforeground="white";
let colorkeybackground="#38393D";//gray
let colorkeybackgroundclick="lime";
let colorkeyboardopacity=0.5;
let fontsizesmall=10;
let fontsizebig=15;
let repeattimeout=500;
let repeatinterval=100;
let dblclickdelay=300;
let iconscale=0.4;
let fontscale=0.5;

let style;
let floor=Math.floor;
let FPS;
let ifra,running=false;

let keyboard, keys=createkeys();
let T=createtextarea();

T.V=T.game=gameprograms.toString().replace(/^.*|.*$/g,"");
T.editor=""; T.editing=false; T.find={value:"",position:0}; T.pastetext="";
T.S=T.E=T.V.indexOf("{")+1;
T.blur(); T.focus();

new Promise(r=>setTimeout(r,0)).then(()=>new Promise(r=>requestAnimationFrame(a=>requestAnimationFrame(b=>r(floor(1000/(b-a))))))).then(r=>FPS=r);

function run(){
if(T.editing)return;
if(running){
  running=false;ifra.remove();ifra=undefined;
  T.focus();
}else{
  let n=currentgame()?.name;
  if(n==undefined)return;
  running=true;
  ifra=element("iframe");
  style=ifra.style;
  style.border=0;
  style.width=innerWidth;
  style.height=innerWidth;
  style.position="fixed";
  style.backgroundColor="pink";
  ifra.contentWindow.eval("let FPS="+FPS+";"+T.V+n+"()");
  T.blur();
  setTimeout(()=>{ style.zIndex=9;},50);
}
}

function save(){
keyboard.clickcnt??=0;
if(++keyboard.clickcnt>1)return;
setTimeout(()=>{

if(keyboard.clickcnt==2){

function diff(a,b,c){
a=a.replace(/^\/\/.*\n/gm,"").split("\n");
b=b.replace(/^\/\/.*\n/gm,"").split("\n");
return b.filter(o=>!a.includes(o))?.map(o=>c+" "+o)?.join("\n")||c+" no change";
}
let b="<meta name='viewport' content='width=device-width, initial-scale=1'/><\script>onload=()=>{ ide();"+ide+"//end ide\n\nfunction gameprograms(){"+T.V+"}}<\/script>"
fetch(url).then(r=>r.text()).then(a=>{
  view("Diff").textContent="Diff "+url+":\n"+(diff(b,a,"<")+"\n"+diff(a,b,">"));
}).catch(error=>alert(error));

}else{

function timestamp(){
let time=new Date();
return "FullYear Month Date Hours Minutes Seconds".split(" ").reduce((s,i)=>s+((time["get"+i]()+(i=="Month"?1:0)).toString().padStart(2,"0")),"");
}
let a=element("a");
a.hidden=true;
let s;
if(T.editing){
  s="<meta name='viewport' content='width=device-width, initial-scale=1'/><\script>onload=()=>{ ide();function ide(){"+T.V+"}//end ide\n\n"+gameprograms+"}<\/script>";
}else{
  s="<meta name='viewport' content='width=device-width, initial-scale=1'/><\script>onload=()=>{ ide();"+ide+"//end ide\n\nfunction gameprograms(){"+T.V+"}}<\/script>";
}
a.href=URL.createObjectURL(new File([s],"",{type:"text/html"}));
a.download=timestamp()+file;
a.click();
URL.revokeObjectURL(a.href);
a.remove();
a=undefined;

}

keyboard.clickcnt=0;
},dblclickdelay);
}

function zoom(){
keyboard.clickcnt??=0;
if(++keyboard.clickcnt>1)return;
setTimeout(()=>{
if(keyboard.clickcnt==2){//Doubleclick for fullscreen
  if(document.fullscreenElement){
    document.exitFullscreen();
  }else{
    document.documentElement.requestFullscreen({navigationUI:"show"});
  }
}else{//Change font size
  style=T.style;
  style.fontSize=(fontsizebig+fontsizesmall)-parseInt(style.fontSize);
  T.blur();T.focus();
}
keyboard.clickcnt=0;
},dblclickdelay);
}

function complete(){
let word,wordlength,ftop,found,first=0,last=-1,i=T.S;
while((--i>=0) && /[a-zA-Z0-9.]/.test(T.V[i]));
word=T.V.slice(i+1,T.S),wordlength=word.length;if(wordlength==0)return;
ftop=T.editing?1:currentgame()?.ftop;
let find=(s,e,a)=>[...(T.V.slice(s,e).replaceAll(/"([^"]*)"|\/\/.*$/gm,"").matchAll("\\b"+word+"\\w*"))].at(a)?.[0];
for(let f of [[ftop,T.S-wordlength-1,last],[T.S,Infinity,first],[0,ftop,last]]){
  if((found=find(...f))!=undefined)break;
}
if(found==undefined)return;
T.R(found.slice(wordlength),T.S,T.S,"end");
}

function comment(){
let bl=T.V.lastIndexOf("\n",T.S-1)+1;
let el=T.V.indexOf("\n",T.S)+1;
let s=T.V.slice(bl,el);
if(s.startsWith("//")){
  T.R("",  bl,bl+2);T.S=T.E=el-2;
}else{
  pastetoggle(s);
  T.R("//",bl,bl);  T.S=T.E=el+2;
}
}

function arrow(direction){
let i=T.E;
if(T.find.value!==""){T.S=T.E;return;}//rename skip
i+=direction;
if(T.S==T.E){
  T.S=T.E=i;
}else{
  T.E=i;
}
if(T.S!=T.E){
  T.pastetext=T.V.slice(T.S,T.E);
}
}

function enter(){
if(T.find.value!==""){T.pastetext+="\n";T.R("\n",T.S,T.E,"end");T.find.position=T.S;return;}//for unjoin
if(T.S!=T.E){T.S=T.E;return;}
let i=T.V.slice(T.V.lastIndexOf("\n",T.S-1)+1,T.S+1).search(/[^ ]/g);
if(i==-1)i=0;
//if(T.V[T.S-1]=="{")i+=indent;//indent after open-brace
T.R("\n"+" ".repeat(i),T.S,T.S,"end");
}

function backspace(){
if(T.find.value!==""){
  T.pastetext=T.pastetext.slice(0,-1);
  T.find.position--;
}
if(T.S==T.E){
  T.S>0 && T.R("",T.S-1,T.E);
}else{
  if(/\n/.test(T.V.slice(T.S,T.E))){//was a line cut
    T.R("",T.S,T.E);
    T.S=T.E=T.V.indexOf("\n",T.E)+1;//so probable not pasting in same place
  }else{
    T.R("",T.S,T.E);
  }
}
}

function shift(){
if(running){run();return;}
for(let k of keys){
  if(k.shift){
    k.e.textContent=(k.e.textContent==k.d)?k.shift:k.d;
  }
}
}

let restore=function(){//undo/redo
let a=[],curr=0; a.push({value:T.V,position:T.S});
return function(direction){
if(direction===0){//reset
  a.splice(0,Infinity,{value:T.V,position:T.S});
}else if(T.pastetext!=="" && direction==-1){//reset paste
  if(T.S!=T.E){T.E=T.S;}
  pastetoggle();
}else if(direction==undefined){//add
  if(T.V===a.at(-1)?.value)return;
  if(a.length==50){a.shift();}else{curr++;}
  a.splice(curr,Infinity,{value:T.V,position:T.S});
}else{//restore
  if((direction==-1 && curr==0) || (direction==1 && curr==a.length-1))return;
  curr+=direction;
  T.V=a[curr].value;
  T.S=T.E=a[curr].position;
}
}}();

function paste(){
if(T.find.value!==""){//rename is active
  if(T.V.slice(T.S,T.E)===T.find.value){
    T.R(T.pastetext,T.S,T.E,"end");//replace
  }
  let i=T.V.slice(T.E,currentgame()?.fend).search(T.find.value.replace(/(^\w+$)/,"\\b$1\\b"));//find
  if(i<0)return;
  T.S=T.E+i;
  T.blur();T.focus();
  T.E=T.S+T.find.value.length;
  return;
}
if(!(T.pastetext==="" || T.S!=T.E)){//paste
  T.R(T.pastetext,T.S,T.E,"end");
  return;
}
let s=T.V,i=T.E,blockpairs={"(":")","{":"}","[":"]",'"':'"'};
function end(a,b){let cnt=1;while(++i<s.length && (cnt+=s[i]===b?-1:s[i]===a?1:0));}
if(/\w/.test(s[i])){//select word
  if(T.S===T.E){
    while(--i>=0 && /\w/.test(s[i]));
    T.S=i+1;
  }
  while(++i<s.length && /\w/.test(s[i]));
  T.E=i;
}else if(s[i]==" "){//spaces
  while(++i<s.length && / /.test(s[i]));
  T.E=i;
}else if(s[i-1]=="\n" && s[i]=="\n"){//paragraph
  T.S++;
  while(++i<s.length && !/\n{2}/.test(s[i]+""+s[i+1]));
  T.E=i+2;
}else if(s[i]=="\n" && T.S==T.E){//line
  T.E++;
  while(--i>0 && !/\n/.test(s[i]));
  T.S=i+1;
}else if(s[i] in blockpairs){//block
  let i2=i;
  end(s[i],blockpairs[s[i]]);
  if(s.slice(i2,i).includes("\n")){
    T.S=1+s.lastIndexOf("\n",T.S-1);
    i=1+s.indexOf("\n",i);
  }else{
    i++;
  }
  while("\n"==s[i] && i++);
  T.E=i;
}else{
  T.E++;
}
T.find.value="";
pastetoggle(T.V.slice(T.S,T.E));//pastetext=selection
}//end paste


function pastetoggle(p){
let color;
if(p){
  color=colorkeybackgroundclick;
  T.pastetext=p;
}else{
  color=colorkeyforeground;
  T.pastetext="";
  T.find.value="";
}
["Paste","Undo"].forEach(v=>keys.find(k=>k.s?.includes(v)).e.firstChild.firstChild.style.stroke=color);
}

function chars(c){
if(T.S!=T.E){
  T.find.value=T.V.slice(T.S,T.E);
  T.pastetext=c;
}else{
  if(T.find.value!=="" && T.S==T.find.position){
    T.pastetext+=c;
  }else{
    T.find.value="";
  }
}
T.R(c,T.S,T.E,"end");
T.find.position=T.S;
}

function currentgame(){
let i=0,s=T.V,ftop,name;
s=s.replace(/\n\/\/\S*/g,"");
function end(){let cnt=1;while(++i<s.length && (cnt+=s[i]=="{"?1:s[i]=="}"?-1:0));}
while(i<s.length){
  ftop=i=s.indexOf("{",i)+1;
  name=s.slice(s.lastIndexOf(" ",i)+1,s.lastIndexOf("(",i));
  end();
  if(i>=T.S)break;
}
if(name=="" || name=="Library" || /\W/.test(name))return undefined;
return {name:name,ftop:ftop,fend:i,body:s.slice(ftop,i)};
}

let view=function(){
let a=[],title;
return function(f,alt){
let e=a[f];
if(e){
  e.exists=true;
}else{
  e=a[f]=element("div");
  e.className="view";
  e.addEventListener("click",()=>view(f));
}
e.classList.toggle("unhide");//for print
if(e.classList.contains("unhide")){
  title=document.title;
  document.title=alt || f;
  T.blur();
  setTimeout(()=>{e.style.zIndex=9;},50);
  e.style.fontSize=T.style.fontSize;
}else{
  document.title=title;
  T.focus();
  e.style.zIndex=0;
}
return e;
}}();

window.addEventListener("error",(ev)=>{
let e=view("Error");
let s="";
s+=`
${ev.message}
line:${ev.lineno}
column:${ev.colno}
`;
if(running==true){
  running=false;ifra.remove();ifra=undefined;
  if(!(T.V.replace(/\/\/.*\n/g,"").match(/[(){}[\]"]/g).length%2==0)){
    s+=`\nMatching [](){}"": failed`;
  }
  T.S=T.E=T.V.split("\n",ev.lineno-1).join("\n").length+ev.colno;
  T.blur();
  T.focus();
}
e.textContent=s;
},false);//end error

function pretty(){
let body,name;
if(T.editing){
  name="IDE";body=T.V;
}else{
  let c=currentgame();
  if(c==undefined)return;
  ({name,body}=c);
}
let e=view("Pretty",name);
e.style.whiteSpace="pre";
let s=body;

s=s.trim().replace(/</g,'&lt;');
s=s.replace(/^\/\/.*\n/gm,"");
s=c(s,"red",'((([&]{2})|([|]{2})|([?]{2}))=?|[,?:!])');
s=c(s,"green",'\\b('+Array.from(s.matchAll(/((?<fn>\w+)={)/g),v=>v.groups.fn).join('|')+')\\b');//objects
s=c(s,"blue",'\\b('+Array.from(s.matchAll(/(unction +(?<fn>\w+))/g),v=>v.groups.fn).join('|')+')\\b');//your functions
s=c(s,"teal",'(?<!")\\b('+s.match(/[a-z]*/g).filter((v,i,a)=>a.indexOf(v)==i).filter(v=>{try{eval('let '+v+'=1')}catch{return true}}).join("|")+'|undefined)\\b(?!")'); //keywords
s=c(s,"brown",'(//.*)');//comments
s=c(s,"olive",'([0-9]+|".*?")');//literals
s=c(s,"purple",'([(){}[\\]])');//pairs
let i=0;let mw=s.match(/\n/g).length.toString().length; s=s.replace(/^/gm,()=>String(++i).padStart(mw," ")+" ");//line numbers

e.innerHTML=s;
setTimeout(()=>e.querySelectorAll('span span').forEach(s=>s.style.color='inherit'),0);
function c(s,color,match){if(match.replace(/[()]|\\b/g,"")==="")return s; return s.replace(RegExp(`${match}`,'g'),`<span style=color:${color}>$1</span>`);}

}//end pretty

function misc(){
let e=view("Misc"); if(e.exists)return;
e.style.overflowWrap="anywhere";
let con,c;

con=element("div",e);
con.insertAdjacentHTML("beforeend","<br><label>Edit the Editor  </label>");
c=element("button",con);c.textContent="off"
c.addEventListener("click",e=>{
  if(T.editing){
    e.target.textContent="off";
    if(T.editor!==T.V){
    alert(`
Saving changes to IDE...
To see changes, open the new timestamped IDE html file.
Unlike editing games, once the editor is broken, the broken editor cannot fix itself and a prior timestamped IDE html file must be used.
    `);
      save();
    }
    T.V=gameprograms.toString().replace(/^.*|.*$/g,"");
    T.S=T.E=T.V.indexOf("{")+1;T.blur();T.focus();
    T.editing=false;
    restore(0);
  }else{
    if(T.game!==T.V){
      if(!confirm("Unsaved game data will be lost"))return;
    }
    e.target.textContent="on";
    T.editing=true;
    T.V=ide.toString().replace(/^.*|.*$/g,"");
    T.S=T.E=T.V.indexOf("{")+1;T.blur();T.focus();
    T.editor=T.V;
    restore(0);
  }
});

con=element("div",e);
con.insertAdjacentHTML("beforeend","<br><label>Color Picker  </label>");
c=element("input",con);c.type="color";
c.addEventListener("change",(e)=>pastetoggle(e.target.value),false);

let measure=element("span"); measure.style.visibility="hidden";
con=element("div",e);
con.insertAdjacentHTML("beforeend","<br>Icon Picker<br>");
c=element("div",con);
c.style.fontSize=30;
c.insertAdjacentHTML("beforeend",range([[9711,10100],[127744,128764],[128992,130000]]).filter(v=>((measure.innerHTML=String.fromCodePoint(v)) && measure.offsetWidth>8)).reduce((a,v)=>a+"<span>"+String.fromCodePoint(v)+"</span>",""));
c.addEventListener("click",(e)=>pastetoggle(e.target.textContent.codePointAt(0)),false);
measure.remove();

function range(r){
  let a=[];
  r.forEach(v=>a.push(Array.from({length:(v[1]-v[0])+1},(_,i)=>v[0]+i)));
  return a.flat();
}

}//end misc

function help(){
let e=view("Help"); if(e.exists)return;

element("div",e).insertAdjacentHTML("beforeend",
`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="50" height="50">
  <circle cx="15" cy="15" r="15" fill="black" />
  <defs>
    <linearGradient id="grad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:red;stop-opacity:1" />
      <stop offset="100%" style="stop-color:gold;stop-opacity:1" />
    </linearGradient>
  </defs>
  <path d="M0,0,L-1,0,L-2,-1,L0,-4,L2,-1,L1,0 M-1.5,0,L-2,0,L-2,-0.5"
  fill="url(#grad)"
  transform="translate(15 15) scale(4) translate(0 2) rotate(30 0 -2)" />
</svg>

<p><b>About</b>
${about}
</p><p>
<b>Download</b>
${download}
</p><p>
<b>Hello World</b>
At the top of the editor, create this code and click Run:
function helloworld(){
  L.canvas(W/2).icon(127759,W/2,W/2);
}
</p><p>
<b>Run</b>
Runs the game which contains the cursor.
Also stops the game.
</p><p>
<b>Save</b>
Saves to a timestamped file.
The file contains your games AND the Editor.
</p><p>
<b>Pretty Print</b>
Displays a readonly version of code that can be saved as PDF.
</p><p>
<b>Zoom/Fullscreen</b>
Toggles font size.
Doubleclick toggles fullscreen.
</p><p>
<b>Misc</b>
Color-Picker and Icon-Picker put a code in Paste.
Edit-the-Editor enables changes to the editor source code, such as colors, new buttons, etc.
</p><p>
<b>Complete</b>
Completes a word.
Looks for match in current game and then elsewhere.
</p><p>
<b>Comment</b>
Toggles comments for the current line.
Also puts the line in Paste.
</p><p>
<b>Paste</b>
Selects text and puts it in Paste. Once Paste is set, it pastes.
Backspace deletes selected text.
Enter moves the cursor to the end of selection and unselects.
Undo resets Paste.
Selection looks at the character to the right and then selects for:
  newline: line
  word: left,right
  spaces: right
  blank line: next blank line
  blocks: (){}[]""
</p>
<b>Undo/Redo</b>
Restore up to 50 changes.
</p><p>
<b>Rename</b> (find/replace)
To rename, select text, type text, click Paste several times. To skip, click Arrow.
</p><p>
<b>Swipeup</b>
Inserts capital letter, instead of using shift.
</p><p>
<b>Errors</b>
Runtime errors display an error message and automatically jump to the error in code.
</p><p>
<b>Global Variables and Aliases</b>
FPS=(frames per second)
W=innerWidth;
floor=Math.floor;
</p><p>
<b>Overridden</b>
Array sort: compares numbers instead of strings.
</p><p>
<b>Variable tracking</b>
L.debug(string,canvas)
</p><p>
<b>Random number</b>
number=L.rnd(max,min)
</p><p>
<b>Random biased sets (reduces repetition)</b>
set=L.RandomArray(quantity,range)
set.next()
</p><p>
<b>Sound</b>
sound=L.Sound()
sound.rocket()
</p><p>
<b>Canvas</b>
canvas=L.canvas(fontsize,iconstart)
canvas.icon(emoji,x,y)
canvas.clear()
canvas.black()
canvas.white()
</p><p>
<b>Color gradient</b>
canvas.fillStyle=L.gradient(canvas,bottom,height,[[stop,color],...])
</p><p>
<b>Shapes</b>
canvas.fill(L.shape([[x,y,...],...],scale))
</p><p>
<b>Pixel to Vector</b>
canvas.fill(L.shape(L.vertices(pixels)))
</p><p>
<b>Features</b>
Designed for phones and tablets.
No setup required.
One file.
Easy to share.
Offline.
Vanilla javascript.
No dependencies.
One click run.
Context aware logic helps reduce task steps.
Less work to refactor your code.
Easy to modify editor.
Edit the editor in the editor.
Editor is less than 500 lines of significant code.
Fully programmable keyboard, including creating your own button icons and functions.
Supports swipe, doubleclick, longpress.
</p><p>
<b>Game Controls</b>
Ski - Click anywhere.
Pairs - Click in squares.
Smash - Click the pumpkin.
Monkeymaze - Click quadrants.
Snake - Click vertical half if snake is horizontal, etc.
Chess - Click piece and destination. Longpress to change piece.
Marslander - Click on right or left of canvas. To disable sound, comment snd.rocket().
</p>
`);

let con,c;
con=element("div",e);
con.insertAdjacentHTML("beforeend", "<b>Buttons</b><br><br>");
for(let k of keys){
  if(!k.s)continue;
  c=k.d();
  c.firstChild.style.stroke="black";
  con.appendChild(c);
  con.insertAdjacentHTML("beforeend"," "+k.s+"<br><br>");
}

}//end help

function createkeys(){
let keys=[
{r:0,c:8, f:()=>save(),           s:"Save",          d:()=>sv("M5 3 v2 h-10 v-2 M 0 4 v-8 M0 4 l-4 -4 M0 4 l4 -4")},
{r:0,c:9, f:()=>run(),            s:"Run",           d:()=>sv("M5 0 l-9 5 v-10 l9 5")},
{r:0,c:7, f:()=>pretty(),         s:"Pretty",        d:()=>sv("M4 -3 h-2 v-2 l2 2 v8 h-8 v-10 h6")},
{r:0,c:4, f:()=>help(),           s:"Help",          d:()=>sv("M1 0 v5 h-2 v-5 h2 M1 -2 h-2 v-2 h2 v2")},
{r:0,c:5, f:()=>misc(),           s:"Misc",          d:()=>sv("M0 -5 l5 5 l-5 5 l-5 -5 l5 -5")},
{r:0,c:6, f:()=>zoom(),           s:"Zoom",          d:()=>sv("M0 -5 l-4 10 M0 -5 l4 10 M2 0 h-4 M2 0 l-2 5 M1 2.5 h2")},
{r:1,c:1, f:()=>arrow(-1),        s:"Left",          d:()=>sv("M-4 0 h8 M-4 0 l4 -4 M-4 0 l4 4")},
{r:1,c:2, f:()=>arrow(1),         s:"Right",         d:()=>sv("M 4 0 h-8 M4 0 l-4 -4 M4 0 l-4 4")},
{r:1,c:6, f:()=>restore(-1),      s:"Undo",          d:()=>sv("M5 0 Q0 -5 -5 2 M-5 -3 v5 h5")},
{r:1,c:7, f:()=>restore(1),       s:"Redo",          d:()=>sv("M-5 0 Q0 -5 5 2 M5 -3 v5 h-5")},
{r:6,c:9, f:()=>shift(),          s:"Shift",         d:()=>sv("M4 5 h-8 M-4 -1 l 4 -4 l4 4")},
{r:1,c:4, f:()=>comment(),        s:"Comment",       d:()=>sv("M1 -4 l-6 8 M5 -4 l-6 8")},
{r:1,c:3, f:()=>complete(),       s:"Complete",      d:()=>sv("M0 0 h-4 v-2 h6 l2 2 l-2 2 h-6")},
{r:1,c:5, f:()=>paste(),          s:"Paste",         d:()=>sv("M2 -4 h2 v9 h-8 v-9 h2 v1 h4 v-1 h-1 v-1 h-2 v1 h-2")},
{r:1,c:9, f:()=>enter(),          s:"Enter",         d:()=>sv("M5 -5 v10 h-10 l5 -5 v5")},
{r:1,c:8, f:()=>backspace(),      s:"Backspace",     d:()=>sv("M5 -4 l-6 8 l-4 -4 l4 -4 l6 8")},
{r:7,c:9, d:" "},
{r:7,c:7, d:"?"},
{r:2,c:0, d:"\""},
{r:2,c:4, d:"("},
{r:2,c:5, d:")"},
{r:2,c:6, d:"{"},
{r:2,c:7, d:"}"},
{r:2,c:8, d:"["},
{r:2,c:9, d:"]"},
{r:2,c:3, d:","},
{r:2,c:2, d:";"},
{r:2,c:1, d:"."},
{r:7,c:8, d:":"},
{r:3,c:0, d:"&"},
{r:3,c:1, d:"|"},
{r:3,c:2, d:"+"},
{r:3,c:3, d:"-"},
{r:3,c:4, d:"="},
{r:3,c:5, d:"!"},
{r:3,c:6, d:"<"},
{r:3,c:7, d:">"},
{r:3,c:8, d:"*"},
{r:3,c:9, d:"/"},
{r:4,c:0, d:"1", shift:"\\"},
{r:4,c:1, d:"2", shift:"`"},
{r:4,c:2, d:"3", shift:"'"},
{r:4,c:3, d:"4", shift:"@"},
{r:4,c:4, d:"5", shift:"#"},
{r:4,c:5, d:"6", shift:"_"},
{r:4,c:6, d:"7", shift:"%"},
{r:4,c:7, d:"8", shift:"~"},
{r:4,c:8, d:"9", shift:"^"},
{r:4,c:9, d:"0", shift:"$"},
{r:5,c:0, d:"q", shift:"Q"},
{r:5,c:1, d:"w", shift:"W"},
{r:5,c:2, d:"e", shift:"E"},
{r:5,c:3, d:"r", shift:"R"},
{r:5,c:4, d:"t", shift:"T"},
{r:5,c:5, d:"y", shift:"Y"},
{r:5,c:6, d:"u", shift:"U"},
{r:5,c:7, d:"i", shift:"I"},
{r:5,c:8, d:"o", shift:"O"},
{r:5,c:9, d:"p", shift:"P"},
{r:6,c:0, d:"a", shift:"A"},
{r:6,c:1, d:"s", shift:"S"},
{r:6,c:2, d:"d", shift:"D"},
{r:6,c:3, d:"f", shift:"F"},
{r:6,c:4, d:"g", shift:"G"},
{r:6,c:5, d:"h", shift:"H"},
{r:6,c:6, d:"j", shift:"J"},
{r:6,c:7, d:"k", shift:"K"},
{r:6,c:8, d:"l", shift:"L"},
{r:7,c:0, d:"z", shift:"Z"},
{r:7,c:1, d:"x", shift:"X"},
{r:7,c:2, d:"c", shift:"C"},
{r:7,c:3, d:"v", shift:"V"},
{r:7,c:4, d:"b", shift:"B"},
{r:7,c:5, d:"n", shift:"N"},
{r:7,c:6, d:"m", shift:"M"},
];

keys.cols=keys.reduce((a,k)=>(a>k.c)?a:k.c,0)+1;
keys.rows=keys.reduce((a,k)=>(a>k.r)?a:k.r,0)+1;
keys.keyboardwidth=floor((innerWidth<(screen.width*0.9))?(innerWidth):Math.min((innerWidth),((innerHeight-innerWidth)*keys.cols/keys.rows)));
keys.keyboardfontsize=floor(keys.keyboardwidth/(keys.cols/fontscale));
let scale=keys.keyboardwidth/keys.cols;
let b=scale*iconscale;
keys.clicked=(ev)=>{
  let r=floor((ev.y-ev.currentTarget.offsetTop)/(scale));
  let c=floor((ev.x-ev.currentTarget.offsetLeft)/(scale));
  return keys.find(k=>k.r==r && k.c==c);
}

function sv(shape){
let s=document.createElementNS("http://www.w3.org/2000/svg","svg");
let p=s.appendChild(document.createElementNS("http://www.w3.org/2000/svg",'path'));
style=s.style;
style.width=b;
style.height=b;
style=p.style;
style.stroke=colorkeyforeground;
style.vectorEffect='non-scaling-stroke';
style.fill="none";
style.strokeWidth=1;
p.setAttribute('transform',`translate(${(b*0.5)},${(b*0.5)}) scale(${b/10})`);
p.setAttribute('d',shape);
return s;
}

keyboard=element("div");
for(let k of keys){
  k.e=element("div",keyboard);
  if((typeof k.d=="function")){
    k.e.appendChild(k.d());
  }else{
    k.e.textContent=k.d;
  }
  style=k.e.style;
  style.display="flex";
  style.justifyContent="center";
  style.alignItems="center";
  style.borderRadius="20%";
  style.backgroundColor=colorkeybackground;
  style.color=colorkeyforeground;
  style.gridColumn=k.c+1;
  style.gridRow=   k.r+1;
}
style=keyboard.style;
style.backgroundColor=`rgb(0 0 0 / ${colorkeyboardopacity*100}%)`;
style.touchAction="none";
style.userSelect="none";
style.position="fixed";
style.display="grid";
style.gap="2%";
style.zIndex=2;
style.bottom=0;
style.right=0;
style.fontFamily="monospace";
style.fontSize=keys.keyboardfontsize;
style.width=keys.keyboardwidth;
style.aspectRatio=keys.cols/keys.rows;
style.gridTemplateColumns=`repeat(${keys.cols},1fr)`;
style.gridTemplateRows=   `repeat(${keys.rows},1fr)`;

keyboard.addEventListener("pointerdown",(ev)=>{
ev.preventDefault();
let k=keys.clicked(ev);
keys.prev=k;
if(k==undefined)return;
if(k.s?.includes("Save"))return;//prevent save loop
keyboard.timeout=setTimeout(()=>{keyboard.interval=setInterval(()=>{//longpress
  if(k.f){k.f();}else{chars(k.e.textContent);}
  T.focus();
},repeatinterval);},repeattimeout);
},false);

keyboard.addEventListener("pointerup",(ev)=>{
clearTimeout(keyboard.timeout);if(keyboard.interval){clearInterval(keyboard.interval);keyboard.interval=undefined;return;}
let k=keys.clicked(ev);
if(k==undefined)return;
if(!(keys.prev.r==k.r && keys.prev.c==k.c)){//swipeup uppercase
  if(keys.prev.shift==undefined)return;
  k=keys.prev;
  chars(k.shift);
}else{
  if(k.f){k.f();}else{chars(k.e.textContent);}
}
k.e.style.backgroundColor=colorkeybackgroundclick;
setTimeout(()=>k.e.style.backgroundColor=colorkeybackground,100);
if(!(/Save|Run|Help|Misc|Zoom|Left|Right|Undo|Redo|Shift/.test(k.s)))restore();
},false);

return keys;
}//end createkeys

function createtextarea(){
let T=element("textarea");
Object.defineProperty(T,"V",{get(){return this.value;},          set(v){this.value=v;}});
Object.defineProperty(T,"S",{get(){return this.selectionStart;}, set(v){this.selectionStart=v;}});
Object.defineProperty(T,"E",{get(){return this.selectionEnd;},   set(v){this.selectionEnd=v;}});
T.R=function(...args){this.setRangeText(...args);}
T.inputMode="none";
T.spellcheck=false;
style=T.style;
style.height="100%";
style.width="100%";
style.padding=`10ch 2ch ${innerHeight} 2ch`;
style.position="fixed"
style.caretColor="white";
style.backgroundColor=colortextareabackground;
style.color=colortextareaforeground;
style.fontSize=fontsizebig;
style.fontFamily="monospace";
style.touchAction="pan-y";
style.zIndex=1;
return T;
}//end createtextarea


function element(e,p){
if(!p) return document.body.appendChild(document.createElement(e));
else   return             p.appendChild(document.createElement(e));
}

}//end ide

function gameprograms(){





function ski(){
let speed=W/FPS/3,os=[],c=L.canvas(),hit;
c.white();
c.fillStyle=L.gradient(c,W,0,[[.2,"blue"],[.8,"skyblue"]]);
c.fill(L.shape([[0,0,W,W,W,0]]));

os.push((function(){        // Motion Effect
let s=floor(W/30),c=L.canvas(),lw=s/5;
c.strokeStyle="whitesmoke"; c.lineWidth=lw; c.setLineDash([s,s]); c.moveTo(0,lw); c.lineTo(W,W+lw);
return function(){ c.clear(); c.lineDashOffset+=speed; c.stroke(); };
})());

for(let i=0;i<2;i++)
os.push((function(){        // Tree
let s=floor(W/10),c=L.canvas(s),x=0;
return function(){ c.clear(); x=x>0?x-speed:L.rnd(W*2,W); c.icon(hit?.(x)?128165:127794,x,x); };
})());

os.push((function(){        // Skier
let s=floor(W/20),c=L.canvas(s),x=W/4,tgl=1,i=0,time=floor(s/speed),reset=3*time;
c.fillStyle="red"; c.scale(-1,1); c.translate(-x,x); c.icon(9975);
addEventListener("click",()=>i||=1,false);
hit=function(t){ return((x-s)<t && t<(x+s) && !(0<i && i<reset)); }
function jump(){ c.clearRect(-s,-s,s*2,s*2); c.translate((tgl*=-1)*(s),0); c.icon(9975); }
return function(){ if(i==1 || i==reset){ jump(); } if(i==reset){ i=0; } i && i++; };
})());

(function animation(){ os.forEach(o=>o?.()); requestAnimationFrame(animation); })()

}//end ski




function marslander(){
addEventListener("click",move,false);
let snd=L.Sound();
let cb=L.canvas(),cf=L.canvas();
let p=floor(W/20);
let mountain=[floor(W*0.70)];
let landed,close,bad,played=false;
let fuelstart=20,fuel=fuelstart;
let my,lm,x,y,xx,yy;
let yt=W/FPS/10,yd=yt/3,ya=yd/FPS,yl=yt/(3/2),xv=yt/2/4,xl=xv*2;
let cold=L.gradient(cf,0,-p,[[.2,"skyblue"],[.8,"blue"]]);
let hot =L.gradient(cf,0,-p,[[.2,"gold"]   ,[.8,"red"]]);
let rocketleft =L.shape([[0,0,-1,0,-2,-1,0,-4,2,-1,1,0],[-1.5,0,-2,0,-2,-0.5]],p/4);
let rocketright=L.shape([[0,0,-1,0,-2,-1,0,-4,2,-1,1,0],[ 1.5,0, 2,0, 2,-0.5]],p/4);
let rocketnone =L.shape([[0,0,-1,0,-2,-1,0,-4,2,-1,1,0]]                      ,p/4);
let ship=rocketnone;
init();

function init(){
let tgl=-1;
let rise;
let mx2=0;
let lx=L.rnd(W-p);
lm=lx+(p/2);
played&&=((fuel=fuel<0?fuelstart:fuel>120?120:fuelstart+fuel),false);
ship=rocketnone;
x=L.rnd(W);y=0;
xx=0.0;yy=yt;
cb.fillStyle="black";cb.fillRect(0,0,W,W);
cb.fillStyle="white";
for(let stars=W*W/2000;stars>0;stars--){cb.fillRect(L.rnd(W),L.rnd(W),1,1);}
for(let mx=0;mx<W;mx++){
  if(mx==lx){
    rise=0;
    mx2=lx+p;
  }else if(mx==mx2){
    rise=(tgl*=-1)*L.rnd(5,1);
    mx2=mx2+L.rnd(floor(W/10),floor(W/20));
  }
  rise*=((mountain[mx]+rise)>(W-p) || (mountain[mx]+rise)<p)?-1:1;
  mountain[mx+1]=mountain[mx]+rise;
}
cb.fillStyle=L.gradient(cb,W,-W,[[0,"hsl("+fuel+",100%,20%)"],[0.3,"white"]]);
cb.fill(L.shape([[W,mountain.at(-1),W,W,0,W,0,mountain[0],...L.vertices(mountain)]]));
animation();
}

function animation(){
x=x>W?0:x<0?W:x+xx;
y+=yy=yy>yt?yt:yy+ya;
my=mountain[floor(x)];
landed=(y>my);
close =(y>my-p);
if(close){yy-=(ya*0.80);xx*=0.98;}
bad=(yl<yy || xl<Math.abs(xx) || (p/4)<Math.abs(x-lm));
if(played && landed && bad){
  fuel-=fuelstart*2;
  ship=L.shape([Array.from({length:40},()=>L.rnd(p)-p/2)]);
}
cf.resetTransform();
cf.clearRect(0,0,W,W);
cf.translate(x,y);
cf.rotate(xx/4);
cf.fillStyle=(bad?hot:cold);
cf.fill(ship);
if(landed){setTimeout(init,1000);return;}
requestAnimationFrame(animation);
}

function move({pageX}){
snd.rocket();
played=true;
fuel--;
yy-=yd;
if(pageX<(W/2)){ xx+=xv;ship=rocketleft;  }
else           { xx-=xv;ship=rocketright; }
setTimeout(()=>         ship=rocketnone,200);
}

}//end marslander





function monkeymaze(){
addEventListener("click",move,false);
let rows=12,qty=3,p=floor(W/rows);
let cb=L.canvas(p*0.7),cf=L.canvas(p*0.7);
let t=Array.from({length:rows}),rna=L.RandomArray(qty,rows);
let banana={x:0,y:0,icon:127820};
let monkey={x:0,y:0,icon:128018};
init();

function init(){
cb.white();
cf.clearRect(0,0,W,W);
t.forEach((_,i,a)=>a[i]=rna.next().sort());
t.forEach((y,iy)=>y.forEach(x=>draw(cb,{x:x,y:iy,icon:127796})));
draw(cb,rnd(banana));
draw(cf,rnd(monkey));
}

function move({pageX,pageY}){
let dx=pageX-(W/2),dy=pageY-(W/2),{x,y}=monkey;
if(dx>dy) if(-dx>dy){while(t[y+=-1]?.every(e=>e!=x));}else{x=t[y][t[y].indexOf(x)+1];}
else      if(-dx<dy){while(t[y+= 1]?.every(e=>e!=x));}else{x=t[y][t[y].indexOf(x)-1];}
y=t[y] && y;if(x==undefined || y==undefined)return;
monkey.x=x;monkey.y=y;
cf.clearRect(0,0,W,W);draw(cf,monkey);
if(monkey.x==banana.x && monkey.y==banana.y){setTimeout(init,1000);return;}
}

function rnd(o){o.y=L.rnd(rows);o.x=t[o.y][L.rnd(qty)];return o;}
function draw(cn,{x,y,icon}){cn.icon(icon,x*p+(p/2),y*p+(p/2));}

}//end monkeymaze





function snake(){
addEventListener("click",move,false);
let cb=L.canvas();
let r=10,p=floor(W/r),m=r*r,head=m-r,food=head+3,snake=[head];
let du=()=>-r+m*(head<r);
let dd=()=>+r-m*(head>=(m-r));
let dl=()=>-1+r*(head%r==0);
let dr=()=>+1-r*(head%r==(r-1));
let d=dr;
cb.white();
setInterval(animation,500);

function animation(){
head+=d();
if(snake.includes(head)){cb.white();snake=[head];}
snake.push(head);
draw(head,"blue");
if(head==food){food=L.rnd(m);}
else{draw(snake.shift(),"white");}
draw(food,"red");
}

function move({pageX,pageY}){d=(d==du || d==dd)?pageX<(W/2)?dl:dr:pageY<(W/2)?du:dd;}
function draw(i,color){cb.fillStyle=color;cb.fillRect((i%r)*p,floor(i/r)*p,p,p);}

}//end snake





function chess(){
addEventListener("pointerdown",({pageX:x,pageY:y})=>{x=floor(x/p);y=floor(y/p);
timeout=setTimeout(()=>{interval=setInterval(()=>{board[y][x]=board[y][x]?board[y][x]-1:12; move();},500);},1000);
},false);
addEventListener("pointerup"  ,({pageX:x,pageY:y})=>{x=floor(x/p);y=floor(y/p);
clearTimeout(timeout);if(interval){clearInterval(interval);interval=undefined;return;}
move(x,y);
},false);

let board=[
[ 9,11,10, 8, 7,10,11, 9,],
[12,12,12,12,12,12,12,12,],
[ 0, 0, 0, 0, 0, 0, 0, 0,],
[ 0, 0, 0, 0, 0, 0, 0, 0,],
[ 0, 0, 0, 0, 0, 0, 0, 0,],
[ 0, 0, 0, 0, 0, 0, 0, 0,],
[ 6, 6, 6, 6, 6, 6, 6, 6,],
[ 3, 5, 4, 2, 1, 4, 5, 3,],
];
board.run=function(func){this.forEach((y,iy)=>y.forEach((_,ix)=>func(iy,ix)));}

let timeout,interval,p=W/board.length,cb=L.canvas(),cf=L.canvas(p,9811),tgl=1,prev;
board.run((y,x)=>{cb.fillStyle=(y+x)%2?"green":"white";cb.fillRect(y*p,x*p,p,p);});
move();

function move(x,y){
if(x && (!tgl || board[y][x])){(board[y][x]=(tgl^=1)?prev:((prev=board[y][x]),0));}
cf.clearRect(0,0,W,W);
board.run((y,x)=>{cf.icon(board[y][x]||"",x*p+(p*0.5),y*p+(p*0.6));});
}

}//end chess





function pairs(){
addEventListener("click",({pageX:x,pageY:y})=>move(floor(x/p)+floor(y/p)*rows),false);
let rows=4,p=floor(W/rows),m,found,pair,misses=0;
let rna=L.RandomArray((rows*rows/2),66);
let cb=L.canvas(),cf=L.canvas(p*0.4,127789);
cb.white();
for(let i=0;i<(rows*rows);i++){cb.strokeRect(i%rows*p,floor(i/rows)*p,p,p);}
init();

function init(){
found=[];pair=[];cf.clearRect(0,0,W,W);misses=0;
m=rna.next();m=[...m,...m];
let r,i=m.length;
while(i-- && ((r=L.rnd(i)),([m[r],m[i]]=[m[i],m[r]])));
}

function move(i){
if(found.length==m.length-2){alert("Misses: "+misses);init();return; }
if(pair.includes(i) || found.includes(i)){return;}
if(pair.length==2){
  if(m[pair[0]]==m[pair[1]]){found.push(...pair);}
  else{pair.forEach(v=>cf.clearRect(v%rows*p,floor(v/rows)*p,p,p));misses++;}
  pair=[];
}
pair.push(i);
cf.icon(m[i],i%rows*p+p*0.5,floor(i/rows)*p+p*0.6);
}

}//end pairs





function smash(){
addEventListener("click",move);
let rows=3,p=floor(W/rows),icon={x:0,y:0};
let c=L.canvas(p*0.7);
let min=700,decay=200/10,scale=decay*200,interval;
interval=scale/decay++;
animation();

function animation(){
icon.x=L.rnd(rows);let t=L.rnd(rows-1);icon.y=t+(t>=icon.y);
c.white();c.icon(127875,icon.x*p+(p/2),icon.y*p+(p/2));
L.debug(floor(min+interval),c);
setTimeout(animation,(min+interval));
}

function move({pageX:x,pageY:y}){
if(!(floor(x/p)==icon.x && floor(y/p)==icon.y))return;
interval=scale/decay++;
c.icon(128165,icon.x*p+(p/2),icon.y*p+(p/2));
}

}//end smash








function Library(){
element("style").textContent=` *{margin:0;padding:0;position:fixed;box-sizing:border-box;} `;

function RandomArray(qty,range){
let a=Array.from({length:range},(_,i)=>i);
function next(){
  let v;
  for(let i=0;i<qty;i++){
    v=rnd(range,qty);
    [a[v],a[i]]=[a[i],a[v]];
  }
  return a.slice(0,qty);
}
return {next};
}

function Sound(){
let auc=new AudioContext();
let aubrocket=auc.createBuffer(1,auc.sampleRate*0.2,auc.sampleRate);
aubrocket.getChannelData(0).forEach((_,i,a)=>a[i]=rnd(1,-1));
let rocket=()=>{let s=auc.createBufferSource();s.buffer=aubrocket;s.connect(auc.destination);s.start();}
return {rocket};
}

function canvas(font=12,iconstart=0){
let c=element("canvas");
c.width=c.height=W;
let cn=c.getContext("2d")
cn.textAlign="center";
cn.textBaseline="middle";
cn.font=font+'px monospace';
cn.iconstart=iconstart;
cn.icon=function(n,x=0,y=0){this.fillText((n==="")?"":String.fromCodePoint(this.iconstart+n),x,y);}

cn.clear=function(){
this.clearRect(0,0,this.canvas.width,this.canvas.height);
}
cn.white=function(){
let s=this.fillStyle;
this.fillStyle="white";this.fillRect(0,0,this.canvas.width,this.canvas.height);
this.fillStyle=s;
}
cn.black=function(){
let s=this.fillStyle;
this.fillStyle="black";this.fillRect(0,0,this.canvas.width,this.canvas.height);
this.fillStyle=s;
}
return cn;
}

function gradient(c,b,h,a){let g=c.createLinearGradient(0,b,0,h);a.forEach(e=>g.addColorStop(...e));return g;}
function rnd(b,a=0){return floor(Math.random()*(b-a))+a;}
function element(e){return document.body.appendChild(document.createElement(e));}

function vertices(a){
let v=[];
for(let i=1;i<a.length-1;i++){
  if(a[i-1]-a[i]!=a[i]-a[i+1])v.push(i,a[i]);
}
return v;
}

function debug(v,c){
let f=c.font;c.font="10px monospace";
c.fillText(v,W/2,10);c.font=f;
}

function shape(a,s=1){
let p1=new Path2D,p2,i,j;
for(i of a){
  p2=new Path2D;
  for(j=0;j<i.length;j+=2){
    p2.lineTo(s*i[j],s*i[j+1]);
  }
  p1.addPath(p2);
}
return p1;
}
return {RandomArray,Sound,canvas,gradient,rnd,shape,vertices,debug,element};

};//end library

let W=innerWidth;
let floor=Math.floor;
(function(sort){Array.prototype.sort=function(){return sort.call(this,(a,b)=>a-b)};})(Array.prototype.sort);//Overridden Array sort: compares numbers instead of strings
let L=Library();

}}</script>